<html>
<head>
  <title>Extract Sensor</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
  <script src="fader.js"></script>
  <script type="text/javascript">
	var mqtt;
	var reconnectTimeout = 2000;
	var host="outstanding-engineer.cloudmqtt.com";
	var port=443;
	var now = new Date();
	var acc_start = now.getTime();
	var dt_orient = 0;
	//var acl = new Accelerometer({frequency:60});
	var driver_id = -1;
	var corr  = 0;
	console.log(window.navigator);
	var location_array = [0,0];
	// Create a client instance
    var client = new Paho.MQTT.Client(host, port,"client_id");
    //Example client = new Paho.MQTT.Client("m11.cloudmqtt.com", 32903, "web_" + parseInt(Math.random() * 100, 10));
	
    // set callback handlers
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;
    var options = {
    useSSL: true,
    userName: "odzguzja",
    password: "XIC7binxmQ8e",
    onSuccess:onConnect,
    onFailure:doFail
    }

    // connect the client
    client.connect(options);

    // called when the client connects
    function onConnect() {
    // Once a connection has been made, make a subscription and send a message.
    console.log("onConnect");
    }

    function doFail(e){
    console.log(e);
    }

    // called when the client loses its connection
    function onConnectionLost(responseObject) {
    if (responseObject.errorCode !== 0) {
      console.log("onConnectionLost:"+responseObject.errorMessage);
      }
    }

    // called when a message arrives
    function onMessageArrived(message) {
    console.log("onMessageArrived:"+message.payloadString);
    }
	function initGeolocation() {
	 if (navigator && navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
				console.log("yo");
			} else {
				console.log('Geolocation is not supported');
			}
	}
	 
	function errorCallback() {}
	 
	function successCallback(position) {
		location_array[0] = position.coords.latitude;
		location_array[1] = position.coords.longitude;
		console.log("hami");
		gps_message = new Paho.MQTT.Message(location_array[0] + "," + location_array[1]);
		gps_message.destinationName = "gps" + driver_id;
		client.send(gps_message);
		x = document.getElementById("test");
		x.innerHTML = position.coords.latitude + ',' + position.coords.longitude;
		}
	function handleOrientation(event) {
		console.log(event)
		var absolute = event.absolute;
		var alpha    = event.alpha;
		var beta     = event.beta;
		var gamma    = event.gamma;
		var y = document.getElementById("test2");
		
		y.innerHTML = "Absolute: " + absolute + 
		"<br>Alpha: " + alpha +
		"<br>Beta: " + beta +
		"<br>Gamma: " + gamma;
		orient_message = new Paho.MQTT.Message(absolute + "," + alpha + "," + beta + "," + gamma);
		orient_message.destinationName = "orient" + driver_id;
		client.send(orient_message);
		console.log("Orientation Published");
	}
	if(window.DeviceOrientationEvent){
	  window.addEventListener("deviceorientation", handleOrientation, false);
	}else{
	  console.log("DeviceOrientationEvent is not supported");
	}
	if(window.DeviceMotionEvent){
	  window.addEventListener("devicemotion", handleMotion, true);
	}else{
	  console.log("DeviceMotionEvent is not supported");
	}
	function handleMotion(acl){
		//acl.start();
		console.log(acl);
		z = document.getElementById("test3");
		//acl.addEventListener('reading', () => {
		z.innerHTML ="Acceleration along the X-axis: " + acl.acceleration.x + 
		"<br>Acceleration along the Y-axis: " + acl.acceleration.y +
		"<br>Acceleration along the Z-axis: " + acl.acceleration.z;
		//});
		var now = new Date();
		var end_time = now.getTime();
		var dt_acc = end_time - acc_start;
		//demo2.innerHTML = "Accelerometer not activated.";
		acc_message = new Paho.MQTT.Message(acl.acceleration.x + "," + acl.acceleration.y + "," + acl.acceleration.z + "," + dt_acc);
		acc_start = end_time;
		acc_message.destinationName = "acc" + driver_id;
		client.send(acc_message);
		console.log("Acceleration Published");
	}
	  

	function getDriverId() {
		pw = document.getElementById("pw");
		console.log(pw.value)
		switch (pw.value) {
			case "tehjayson":
				driver_id = 1;
				corr = 1;
				break;
			case "tanweiyang":
				driver_id = 2;
				corr  =1;
				break;
			default:
				driver_id = -1;
				alert("WRONG PASSWORD");
		}
		console.log(driver_id);
		if (corr  ==1){
			document.getElementById("start").style.display = "block";
			document.getElementById("pass").style.display = "none";
		}
	}
	
	function startWork() {
		
		strt = new Paho.MQTT.Message("true");
  		strt.destinationName = "STARTWORKLO" + driver_id;
  		client.send(strt);
		start.innerHTML = "WORK STARTED" ;
		alert("WELCOME BACK TO WORK");
		document.getElementById("reach").style.display = "block";
		document.getElementById("ebye").style.display = "block";
		document.getElementById("start").style.display = "none";
	}
	
	function reachFunction(){
		if (navigator.geolocation) {
    			navigator.geolocation.getCurrentPosition(showReach);
			//navigator.geolocation.watchPosition(showPosition);
  		} else {
   			reach.innerHTML = "Geolocation is not supported by this browser.";
  		}
		
		function showReach(position) {		

			rchlong = position.coords.longitude;
			rchlat = position.coords.latitude;
			gps = new Paho.MQTT.Message(driver_id + "," + rchlong + "," + rchlat);
  			gps.destinationName = "REACH" + driver_id;
  			client.send(gps);
 			alert("ALERT SENT TO CONTROL CENTER");
		}
	
	}	
	
	function showData() {
  		var x = document.getElementById("data");
  		if (x.style.display === "none") {
   			 x.style.display = "block";
  		} else {
    			x.style.display = "none";
  		}
	}
	
	function endWork() {
		end = new Paho.MQTT.Message("true");
  		end.destinationName = "ENDWORKLO" + driver_id;
  		client.send(end);
		ebye.innerHTML = "SEE YOU TOMORROW";
		document.getElementById("reach").style.display = "none";
	}
	
  </script>
</head>
<body>
	<h1>FleetHub</h1>
	<div id = "pass">
	<form id="frm1" action="/action_page.php">
	  Password: <input id="pw" type="password" name="password"><br>
	  <input type="button" value="Enter" onclick="getDriverId()"></input>
	</form> 
	</div>
	
	<div id = "start"  style="display : none">
		<p>CLICK HERE TO START WORK</p>
		<button onclick="startWork()">START WORK</button>
	</div>
	
	<div id="reach"  style="display : none"><p> CLICK HERE WHEN ARRIVE </p>
		<button onclick="reachFunction()" style="margin:5px;">REACH</button>
		<button onclick="showData()" style="margin:5px;">Show Data</button>
	</div> 
	
	<div id="ebye"  style="display : none">
		<p> CLICK HERE END WORK </p>
		<button onclick="endWork()">OFFLINE</button>
	</div> 
	
		<div id="test">Loading...</div>
		<div id="test2">Orientation...</div>
		<div id="test3">Acceleration...</div>
		<div id="test4">Gyroscope...</div>
	
	
	
	<script>
		//init();
		window.setInterval(initGeolocation,5000);
	</script>
</body>
</html>
